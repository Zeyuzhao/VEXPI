<!DOCTYPE HTML>
<html>
<head>
    <title>VEX PI Control</title>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script src="https://fastcdn.org/D3.js/3.5.6/d3.min.js"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

    <script type="text/javascript" charset="utf-8">

        $(document).ready(function () {
            var sensors = ['temp', 'light', 'sal', 'wind'];

            var namespace = '/test';
            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);
            var chartData = []
            var dataLength = 20;

            for (var i = 0; i < sensors.length; i++) {
                chartData.push({
                    type: "line",
                    dataPoints: [{x: 0, y: 2 * i}, {x: 1, y: 3 * i + 1}],
                    name: sensors[i],
                    showInLegend: true,
                })
            }
            var chart = new CanvasJS.Chart("chartContainer", {
                title: {
                    text: "Data"
                },
                axisY: {
                    includeZero: false
                },
                data: chartData,
            });
            chart.render();
            socket.on('sensor', dataAppend);

            function dataAppend(msg) {
                for (var i in sensors) {
                    var sensorData = sensors[i];
                    $("#" + sensorData).text(sensorData + ": " + msg[sensorData]);
                    var currentArray = chartData[i]['dataPoints']
                    console.log("Index: " + currentArray.length)
                    console.log("Pushed: " + sensorData);

                    currentArray.push({
                        x: currentArray.length,
                        y: parseInt(msg[sensorData])
                    });
                    if (currentArray.length > dataLength) {
                        currentArray.shift();
                        console.log("Shift")
                    }
                    chart.render();
                }
            }
        });
    </script>
</head>
<body>
<h1>Vex Control</h1>
<p>Async mode is: <b>{{ async_mode }}</b></p>
<h2>Receive:</h2>
<div class="data_storage">
    <div id="chartContainer" style="height: 300px; width: 100%;"></div>
    <p id="temp"></p>
    <p id="light"></p>
    <p id="sal"></p>
    <p id="wind"></p>
</div>
</body>
</html>